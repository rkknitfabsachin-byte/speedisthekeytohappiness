<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ledger Viewer</title>

<style>
:root {
  --glass-bg: rgba(255,255,255,0.65);
  --glass-border: rgba(255,255,255,0.35);
  --shadow: 0 10px 30px rgba(0,0,0,0.12);
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: linear-gradient(135deg, #eaf2ff, #fdfefe);
}

header {
  padding: 14px;
  text-align: center;
  font-weight: 700;
  font-size: 18px;
  backdrop-filter: blur(10px);
}

.filters {
  position: sticky;
  top: 0;
  z-index: 10;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px,1fr));
  gap: 10px;
  padding: 12px;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(12px);
}

.filters input {
  padding: 9px 12px;
  border-radius: 16px;
  border: 1px solid #ddd;
  font-size: 13px;
  outline: none;
}

.filters input:focus {
  border-color: #0b5cff;
}

.list {
  padding: 12px;
}

.card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border);
  border-radius: 22px;
  box-shadow: var(--shadow);
  padding: 14px;
  margin-bottom: 14px;
}

.row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-size: 13px;
}

.label {
  opacity: 0.55;
}

.value {
  font-weight: 600;
}

.total {
  margin-top: 10px;
  font-size: 16px;
  font-weight: 800;
  color: #0b5cff;
  text-align: right;
}

#loading {
  text-align: center;
  padding: 20px;
  opacity: 0.7;
}
</style>
</head>

<body>

<header>ðŸ“˜ Ledger â€“ FY 25-26</header>

<div class="filters" id="filters"></div>
<div id="loading">Loading recordsâ€¦</div>
<div class="list" id="list"></div>

<script>
/* ================= CONFIG ================= */
const API = 'https://wandering-speed-a1af.rkknitfabsachin.workers.dev';

/* ================= STATE ================= */
let page = 1;
let loading = false;
let allData = [];

/* ================= FILTER FIELDS ================= */
const FILTER_KEYS = [
  'date','bill','party','location','item',
  'width','lot','colour','transport','entry'
];

/* ================= FORMATTERS ================= */
function formatNumber(v) {
  if (v === null || v === undefined || v === '' || isNaN(v)) return 'â€”';
  return Number(v).toFixed(2);
}

function formatDate(v) {
  if (!v) return 'â€”';
  const d = new Date(v);
  return isNaN(d) ? 'â€”' : d.toLocaleDateString('en-GB');
}

/* ================= LOAD DATA (SAFE) ================= */
async function loadData() {
  if (loading) return;
  loading = true;

  try {
    const res = await fetch(`${API}?page=${page}`);
    if (!res.ok) throw new Error('API error');

    const json = await res.json();
    allData.push(...json.rows);

    if (json.hasMore) {
      page++;
      await loadData();   // load next page safely
    } else {
      document.getElementById('loading').style.display = 'none';
      renderFilters();
      applyFilters();
      loading = false;
    }
  } catch (e) {
    console.error(e);
    document.getElementById('loading').innerText = 'Failed to load data';
    loading = false;
  }
}

/* ================= FILTER UI ================= */
function renderFilters() {
  const box = document.getElementById('filters');
  if (box.children.length) return;

  FILTER_KEYS.forEach(k => {
    const input = document.createElement('input');
    input.placeholder = 'Filter ' + k.toUpperCase();
    input.dataset.key = k;
    input.oninput = applyFilters;
    box.appendChild(input);
  });
}

/* ================= APPLY FILTERS ================= */
function applyFilters() {
  const inputs = document.querySelectorAll('.filters input');
  let filtered = allData;

  inputs.forEach(inp => {
    if (inp.value.trim()) {
      const val = inp.value.toLowerCase();
      filtered = filtered.filter(r =>
        String(r[inp.dataset.key] || '')
          .toLowerCase()
          .includes(val)
      );
    }
  });

  renderList(filtered);
}

/* ================= RENDER CARDS ================= */
function renderList(data) {
  const list = document.getElementById('list');
  list.innerHTML = '';

  data.forEach(r => {
    list.innerHTML += `
      <div class="card">
        <div class="row"><span class="label">Date</span><span class="value">${formatDate(r.date)}</span></div>
        <div class="row"><span class="label">Bill No</span><span class="value">${r.bill || 'â€”'}</span></div>
        <div class="row"><span class="label">Party</span><span class="value">${r.party || 'â€”'}</span></div>
        <div class="row"><span class="label">Location</span><span class="value">${r.location || 'â€”'}</span></div>
        <div class="row"><span class="label">Item</span><span class="value">${r.item || 'â€”'}</span></div>
        <div class="row"><span class="label">Colour</span><span class="value">${r.colour || 'â€”'}</span></div>
        <div class="row"><span class="label">Lot</span><span class="value">${r.lot || 'â€”'}</span></div>
        <div class="row"><span class="label">Width</span><span class="value">${r.width || 'â€”'}</span></div>
        <div class="row"><span class="label">Transport</span><span class="value">${r.transport || 'â€”'}</span></div>

        <div class="total">â‚¹ ${formatNumber(r.total)}</div>
      </div>
    `;
  });
}

/* ================= START ================= */
loadData();
</script>

</body>
</html>
