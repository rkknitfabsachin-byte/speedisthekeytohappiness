<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ledger Viewer</title>

<style>
:root {
  --glass: rgba(255,255,255,0.7);
  --border: rgba(255,255,255,0.35);
  --shadow: 0 10px 30px rgba(0,0,0,0.12);
}

body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: linear-gradient(135deg,#eaf2ff,#ffffff);
}

header {
  padding: 14px;
  font-weight: 700;
  text-align: center;
}

.filters {
  position: sticky;
  top: 0;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(12px);
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
  gap: 8px;
  z-index: 10;
}

.filters input {
  padding: 8px 10px;
  border-radius: 14px;
  border: 1px solid #ddd;
}

#loading {
  text-align: center;
  padding: 16px;
  opacity: 0.7;
}

.list {
  padding: 12px;
}

.card {
  background: var(--glass);
  backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 20px;
  box-shadow: var(--shadow);
  padding: 14px;
  margin-bottom: 12px;
}

.row {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  margin-bottom: 6px;
}

.label { opacity: 0.55; }
.value { font-weight: 600; }

.total {
  margin-top: 8px;
  text-align: right;
  font-weight: 800;
  color: #0b5cff;
}
</style>
</head>

<body>

<header>ðŸ“˜ Ledger â€“ FY 25-26</header>

<div class="filters" id="filters"></div>
<div id="loading">Loading recordsâ€¦</div>
<div class="list" id="list"></div>

<script>
/* ================= CONFIG ================= */
const API = 'https://wandering-speed-a1af.rkknitfabsachin.workers.dev';
const MAX_PAGES = 200; // safety cap (200 Ã— 100 = 20,000 rows)

/* ================= STATE ================= */
let page = 1;
let allData = [];
let loading = false;

/* ================= FILTER KEYS ================= */
const FILTER_KEYS = [
  'date','bill','party','location','item',
  'width','lot','colour','transport','entry'
];

/* ================= FORMAT ================= */
const fmtNum = v =>
  v !== null && v !== '' && !isNaN(v) ? Number(v).toFixed(2) : 'â€”';

const fmtDate = v => {
  const d = new Date(v);
  return isNaN(d) ? 'â€”' : d.toLocaleDateString('en-GB');
};

/* ================= LOAD DATA (BULLETPROOF) ================= */
async function loadAllData() {
  if (loading) return;
  loading = true;

  for (let i = 0; i < MAX_PAGES; i++) {
    try {
      const res = await fetch(`${API}?page=${page}`);
      if (!res.ok) break;

      const json = await res.json();
      if (!json.rows || json.rows.length === 0) break;

      allData.push(...json.rows);
      page++;

      // render progressively (FAST FEEL)
      renderFilters();
      applyFilters();

    } catch (e) {
      console.error('Fetch failed', e);
      break;
    }
  }

  document.getElementById('loading').style.display = 'none';
  loading = false;
}

/* ================= FILTER UI ================= */
function renderFilters() {
  const box = document.getElementById('filters');
  if (box.children.length) return;

  FILTER_KEYS.forEach(k => {
    const input = document.createElement('input');
    input.placeholder = 'Filter ' + k.toUpperCase();
    input.dataset.key = k;
    input.oninput = applyFilters;
    box.appendChild(input);
  });
}

/* ================= APPLY FILTERS ================= */
function applyFilters() {
  const inputs = document.querySelectorAll('.filters input');
  let data = allData;

  inputs.forEach(inp => {
    if (inp.value.trim()) {
      const v = inp.value.toLowerCase();
      data = data.filter(r =>
        String(r[inp.dataset.key] || '').toLowerCase().includes(v)
      );
    }
  });

  renderList(data);
}

/* ================= RENDER ================= */
function renderList(data) {
  const list = document.getElementById('list');
  list.innerHTML = '';

  data.forEach(r => {
    list.innerHTML += `
      <div class="card">
        <div class="row"><span class="label">Date</span><span class="value">${fmtDate(r.date)}</span></div>
        <div class="row"><span class="label">Bill</span><span class="value">${r.bill || 'â€”'}</span></div>
        <div class="row"><span class="label">Party</span><span class="value">${r.party || 'â€”'}</span></div>
        <div class="row"><span class="label">Location</span><span class="value">${r.location || 'â€”'}</span></div>
        <div class="row"><span class="label">Item</span><span class="value">${r.item || 'â€”'}</span></div>
        <div class="row"><span class="label">Colour</span><span class="value">${r.colour || 'â€”'}</span></div>
        <div class="row"><span class="label">Lot</span><span class="value">${r.lot || 'â€”'}</span></div>
        <div class="row"><span class="label">Width</span><span class="value">${r.width || 'â€”'}</span></div>
        <div class="row"><span class="label">Transport</span><span class="value">${r.transport || 'â€”'}</span></div>
        <div class="total">â‚¹ ${fmtNum(r.total)}</div>
      </div>
    `;
  });
}

/* ================= START ================= */
loadAllData();
</script>

</body>
</html>
